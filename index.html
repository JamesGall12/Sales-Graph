<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Greencare Sales Dashboard - Live</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body {
      background-color: #0f172a;
      color: white;
      font-family: sans-serif;
      padding: 20px;
    }
    .metric-card {
      background-color: #1e293b;
      padding: 20px;
      border-radius: 10px;
      margin: 10px;
      text-align: center;
    }
    .chart-container {
      background-color: #1e293b;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .loading {
      text-align: center;
      padding: 100px;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <h2>Loading sales data...</h2>
  </div>

  <div id="dashboard" style="display: none;">
    <h1>ðŸš€ Greencare Sales Dashboard</h1>
    <div class="metric-card">
      <div><strong>Team Target:</strong> <span id="teamTarget">0</span></div>
      <div><strong>Team Projected:</strong> <span id="teamProjected">0</span></div>
      <div><strong>Team Actual:</strong> <span id="teamActual">0</span></div>
      <div><strong>Achievement Rate:</strong> <span id="achievementRate">0%</span></div>
    </div>

    <div class="chart-container">
      <canvas id="performanceChart" height="200"></canvas>
    </div>

    <div class="chart-container">
      <canvas id="achievementChart" height="200"></canvas>
    </div>
  </div>

  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnA9kBH4aes-Z3UQKFtbRbWBPx9TkDoKd48GddRxYM38rZCFq9ZRABBSainXk9WpHaEGVMi2STlk4V/pub?gid=1556175923&single=true&output=csv";
    let charts = {};

    async function fetchSalesData() {
      try {
        const res = await fetch(SHEET_CSV_URL);
        const csvText = await res.text();
        return parseSalesData(csvText);
      } catch (err) {
        console.error('Failed to load sales data:', err);
        return [];
      }
    }

    function parseSalesData(csvText) {
      const lines = csvText.trim().split('\n');
      const salesPeople = [];
      let currentTarget = 0;
      let currentData = {};

      for (let i = 2; i < lines.length; i++) {
        const [label, value] = lines[i].split(',');
        const numValue = parseInt(value) || 0;

        if (label === 'Target 1') {
          currentTarget = numValue;
        } else if (label === 'Projected - Candice') {
          currentData.candiceProjected = numValue;
        } else if (label === 'Candice') {
          salesPeople.push({ name: 'Candice', target: currentTarget, projected: currentData.candiceProjected, actual: numValue });
        } else if (label === 'Target 2') {
          currentTarget = numValue;
        } else if (label === 'Pojected - Kurt') {
          currentData.kurtProjected = numValue;
        } else if (label === 'Kurt') {
          salesPeople.push({ name: 'Kurt', target: currentTarget, projected: currentData.kurtProjected, actual: numValue });
        } else if (label === 'Target 3') {
          currentTarget = numValue;
        } else if (label === 'Pojected - Ed') {
          currentData.edProjected = numValue;
        } else if (label === 'Projected - Jeff') {
          currentData.jeffProjected = numValue;
        } else if (label === 'Ed') {
          salesPeople.push({ name: 'Ed', target: currentTarget, projected: currentData.edProjected, actual: numValue });
        } else if (label === 'Jeff') {
          salesPeople.push({ name: 'Jeff', target: currentTarget, projected: currentData.jeffProjected, actual: numValue });
        }
      }
      return salesPeople;
    }

    function updateDashboard(data) {
      const teamTarget = data.reduce((sum, p) => sum + p.target, 0);
      const teamProjected = data.reduce((sum, p) => sum + p.projected, 0);
      const teamActual = data.reduce((sum, p) => sum + p.actual, 0);
      const achievementRate = teamTarget > 0 ? (teamActual / teamTarget) * 100 : 0;

      document.getElementById("teamTarget").textContent = teamTarget;
      document.getElementById("teamProjected").textContent = teamProjected;
      document.getElementById("teamActual").textContent = teamActual;
      document.getElementById("achievementRate").textContent = achievementRate.toFixed(1) + "%";

      updateCharts(data);
    }

    function updateCharts(data) {
      if (charts.performance) charts.performance.destroy();
      const ctx1 = document.getElementById("performanceChart").getContext("2d");
      charts.performance = new Chart(ctx1, {
        type: "bar",
        data: {
          labels: data.map(p => p.name),
          datasets: [
            { label: "Target", data: data.map(p => p.target), backgroundColor: "#3b82f6" },
            { label: "Projected", data: data.map(p => p.projected), backgroundColor: "#8b5cf6" },
            { label: "Actual", data: data.map(p => p.actual), backgroundColor: "#10b981" },
          ]
        },
        options: { responsive: true, plugins: { legend: { labels: { color: "white" } } }, scales: { x: { ticks: { color: "white" } }, y: { ticks: { color: "white" } } } }
      });

      if (charts.achievement) charts.achievement.destroy();
      const ctx2 = document.getElementById("achievementChart").getContext("2d");
      charts.achievement = new Chart(ctx2, {
        type: "doughnut",
        data: {
          labels: data.map(p => p.name),
          datasets: [{
            data: data.map(p => p.actual / p.target * 100),
            backgroundColor: ["#3b82f6", "#8b5cf6", "#ec4899", "#10b981"]
          }]
        },
        options: { responsive: true, plugins: { legend: { labels: { color: "white" } } } }
      });
    }

    async function loadDashboard() {
      const data = await fetchSalesData();
      if (!data.length) {
        document.getElementById("loading").innerHTML = '<p style="color:red;">Failed to load data</p>';
        return;
      }
      updateDashboard(data);
      document.getElementById("loading").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
    }

    window.addEventListener("load", loadDashboard);
  </script>
</body>
</html>
